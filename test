#!/usr/bin/env python3
# -*- coding: utf-8 -*-
import csv
import re
import sys
from collections import defaultdict
from pathlib import Path

TAGS_CIBLES = {
    "MIP_CONF_INTRA",
    "MIP_CONF_INTRA_EXTRA",
    "MIP_CONF_EXTRA",
    "MIP_SEC_INTRA",
    "MIP_SEC_INTRA_EXTRA",
    "MIP_SEC_EXTRA",
}

PATTERN = re.compile(r"\b(MIP_[A-Z_]+)\s*\(\s*(\d+)\s*/")
DOSSIER_SCRIPT = Path(__file__).parent

def compter_dans_fichier(fichier: Path, compte_global: defaultdict):
    try:
        with fichier.open(newline="", encoding="utf-8-sig") as f:
            lecteur = csv.reader(f)
            en_tete = next(lecteur, None)
            if en_tete is None:
                print(f"Avertissement : {fichier} est vide.", file=sys.stderr)
                return

            # Recherche de la colonne cible
            try:
                idx_col = en_tete.index("Classification Results (Selected Rules)")
            except ValueError:
                print(
                    f"Avertissement : colonne manquante dans {fichier}.",
                    file=sys.stderr,
                )
                return

            # Lecture ligne à ligne pour limiter la mémoire
            for ligne in lecteur:
                if idx_col >= len(ligne):
                    # Ligne incomplète
                    continue
                cell = ligne[idx_col]
                for tag, n in PATTERN.findall(cell):
                    if tag in TAGS_CIBLES:
                        compte_global[tag] += int(n)

    except UnicodeDecodeError:
        print(f"Erreur d'encodage dans le fichier {fichier}", file=sys.stderr)
    except FileNotFoundError:
        print(f"Fichier introuvable : {fichier}", file=sys.stderr)




def main():
    # Nom du fichier CSV à traiter — à modifier selon vos besoins
    CSV_UNIQUE = DOSSIER_SCRIPT / "fichier1.csv"

    if not CSV_UNIQUE.exists():
        print(f"Fichier introuvable : {CSV_UNIQUE}")
        return

    csv_files = [CSV_UNIQUE]

    # Dictionnaire compteur (valeur par défaut 0)
    compte_global = defaultdict(int)

    for fichier in csv_files:
        compter_dans_fichier(fichier, compte_global)

    if not compte_global:
        print("Aucun tag pertinent trouvé.")
        return

    # Affichage propre
    print("\nRésultats :")
    for tag in sorted(TAGS_CIBLES):
        print(f"{tag:22s} : {compte_global[tag]}")

if __name__ == "__main__":
    main()
